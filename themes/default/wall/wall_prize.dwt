<!DOCTYPE html>
<html lang="zh-CN">
	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
		<title>微信墙</title>
		<link rel="stylesheet" type="text/css" href="__TPL__/wall/css/wechat.css"/>
	</head>
	<body>
		<div class="con" {if $wall.background}style="background-image:url({$wall.background})"{/if}>
            <div class="main">
                <!--logo-->
                <div class="logo">
                    <img src="{$wall.logo}" class="fl"/>
                    <h1 class="fl">{$wall.name}</h1>
                </div>
                
                <!--main-->
                <div class="award-main">
                    <!---->
                    <div class="award-content fl">
                        <div class="award-content-header">
                            <img src="__TPL__/wall/img/choujiang.png" class="fl"/>
                            <h1 class="fl">现场抽奖</h1>
                            <h2 class="fr">参加抽奖人数<span>{$total}</span>人</h2>
                        </div>
                    
                        <div class="award-content-detail">
                            <ul class="award-detail-pic">
                                <li class="active prize0">
                                    <img src="__TPL__/wall/img/unknow.png"/>
                                    <p class="award-content-name">求中奖</p>
                                </li>
                                {foreach from=$no_prize item=no}
                                <li class="prize{$no.id}">
                                    <img src="{$no.headimg}"/>
                                    <p class="award-content-name">{$no.nickname}</p>
                                </li>
                                {/foreach}
                            </ul>
                            <!--<div class="award-detail-num">
                                <span>抽取</span>
                                <select name="prize">
                                    {foreach from=$wall.prize item=prize}
                                    <option value="{$prize.prize_level}">{$prize.prize_level}</option>
                                    {/foreach}
                                </select>
                                <select name="num">
                                    <option value="1">1</option>
                                    <option value="2">2</option>
                                    <option value="3">3</option>
                                    <option value="4">4</option>
                                    <option value="5">5</option>
                                    <option value="6">6</option>
                                </select>
                                <span>人</span> 
                            </div>-->
                            <input type="button" name="start" id="start" value="开始抽奖" />
                            <input type="button" name="stop" id="stop" value="停止抽奖" style="display:none;" />
                        </div>
                    </div>
                    
                    
                    <!---->
                    <div class="fr award-list">
                        <div class="award-list-name">
                            <h1 class="fl">获奖名单</h1>
                            <h2 class="fr">获奖人数：<span id="prize_num">{$prize_num}</span></h2>
                        </div>
                        <div class="award-list-title">
                            <h3 class="fl">序号</h3>
                            <h4 class="fr">用户昵称</h4>
                        </div>
                        <ul id="award">
                        {foreach from=$list item=list key=key}
                            <li>
                                <div class="fl award-list-info">
                                    <span class="fl">{$key}</span>
                                    <img src="{$list.headimg}" class="fl"/>
                                </div>
                                <p class="fr">{$list.nickname}</p>
                            </li>
                        {/foreach}
                        </ul>
                        <input type="button" name="restart" value="重新抽奖" class="award-restart"/>
                    </div>
                </div>
                
                
                <!--footer-->
                <div class="footer">
                    <div class="footer-msg">
                        <h1>{$wall.content}</h1>
                        <ul class="fr">
                            <li class="footer-menu">
                                <a href="{:url('wall_user', array('wall_id'=>$this->_var['wall']['id']))}">
                                    <div class="footer-menu-pic shangqiang">
                                    微信上墙</div>
                                </a>
                            </li>
                            <li class="footer-menu">
                                <a href="{:url('wall_msg', array('wall_id'=>$this->_var['wall']['id']))}">
                                    <div class="footer-menu-pic liebiao">
                                    留言列表</div>

                                </a>
                            </li>
                            <li class="footer-menu">
                                <a href="{:url('wall_prize', array('wall_id'=>$this->_var['wall']['id']))}" class="active">
                                    <div class="footer-menu-pic choujiang active">
                                    抽奖</div>
                                </a>
                            </li>
                        </ul>
                    </div>
                    <p>{$wall.support}</p>
                </div>
            </div>
        </div>
		<script type="text/javascript" src="__PUBLIC__/js/jquery.min.js"></script>
        <script type="text/javascript" src="__TPL__/wall/js/jquery.nicescroll.js" ></script>
        <script type="text/javascript" src="__TPL__/wall/js/jquery.scrollTo.min.js" ></script>
        <script type="text/javascript" src="__TPL__/wall/js/wechat.js" ></script>
        <script type="text/javascript">
        $(function(){
            //开始抽奖
            var len = $(".award-detail-pic li img").length > 0 ? $(".award-detail-pic li img").length - 1 : 0, 
                i = 1, 
                time;
            $("#start").click(function(){
                if(len > 0){
                    time = setInterval(function(){
                        if(i > len){
                            i = 1;
                        }
                        $(".award-detail-pic li").eq(i).addClass("active").siblings("li").removeClass("active");
                        i++;
                    }, 100);
                    $("#stop").css("display", "inline-block");
                    $("#start").css("display", "none");
                }
                else{
                    alert("暂无数据");
                }
            });
            //停止抽奖
            $("#stop").click(function(){
                $.get("{:url('start_draw', array('wall_id'=>$this->_var['wall']['id']))}", '', function(result){
                    if(result.errCode == 0){
                        //中奖
                        $(".award-detail-pic li.prize"+result.data.id).addClass("active").siblings("li").removeClass("active");
                        
                        var key = $("#award li span.fl:last").text();
                        if(key){
                            key = parseInt(key) + 1;
                        }
                        else{
                            key = 1;
                        }
                        var html = '<li><div class="fl award-list-info"><span class="fl">'+key+'</span><img src="'+result.data.headimg+'" class="fl"/></div><p class="fr">'+result.data.nickname+'</p></li>';
                        $("#award").append(html);
                        //获奖人数
                        var prize_num = $("#award li").length ? $("#award li").length : 0;
                        $("#prize_num").html(prize_num);
                        setTimeout(function(){remove_prize(result.data.id)}, 2000);
                    }
                    else if(result.errCode == 1){
                        location.href = result.errMsg;
                    }
                    else{
                        $(".award-detail-pic li:first").addClass("active").siblings("li").removeClass("active");
                        alert(result.errMsg);
                    }
                    return false;
                }, 'json');
                clearInterval(time);
                $("#stop").css("display", "none");
                $("#start").css("display", "inline-block");
            });
            //重置抽奖
            $(".award-restart").click(function(){
                if(confirm("重置抽奖后，中奖用户将会重新放入奖池，确定要重置吗？")){
                    $.get("{:url('reset_draw', array('wall_id'=>$this->_var['wall']['id']))}", '', function(result){
                        if(result.errCode == 0){
                            $("#award").empty();
                            $(".award-detail-pic li:first").addClass("active").siblings("li").removeClass("active");
                            $("#prize_num").html("0");
                        }
                        else if(result.errCode == 1){
                            location.href = result.errMsg;
                        }
                        else{
                            alert(result.errMsg);
                        }
                        location.reload();
                        return false;
                    }, 'json');
                }
            });
        })
        function remove_prize(oid){
            $(".award-detail-pic li:first").addClass("active").siblings("li").removeClass("active");
            $(".award-detail-pic li.prize"+oid).remove();
        }
        </script>
	</body>
</html>