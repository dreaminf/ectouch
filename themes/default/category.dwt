<!DOCTYPE html>
<html>
	<head>
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
		<meta name="apple-mobile-web-app-capable" content="yes" />
		<meta name="apple-mobile-web-app-status-bar-style" content="black" />
		<meta name="format-detection" content="telephone=no" />
		<meta charset="utf-8">
		<title>{$page_title}</title>
		<link rel="stylesheet" href="__TPL__/statics/css/ectouch.css" />
		<script type="text/javascript" src="__TPL__/statics/js/jquery-2.1.4.min.js"></script>
	</head>
	<style>
            a.a-sequence {width: 3.5rem;height: 0rem;line-height: 3rem;margin-left:0.5rem;}
            a.s-filter {line-height: 3rem;padding-left: 0rem;}
    </style>
	<body class="">
		<div id="loading"><img src="__TPL__/statics/img/loading.gif" /></div>
		<div class="con">
			<div class="category">
				<section class="search">
					<div class="text-all dis-box j-text-all">
						<div class="box-flex input-text">
							<a class="a-search-input j-search-input-new" href="javascript:;"></a>
							<input class="j-input-text" type="text" placeholder="商品搜索" />
							<i class="iconfont icon-guanbi is-null j-is-null"></i>
						</div>
						<a class="a-sequence j-a-sequence"><i class="iconfont icon-pailie" data="1"></i></a>
					</div>
				</section>
				<!-- #BeginLibraryItem "/library/new_goods_list.lbi" --><!-- #EndLibraryItem -->
			</div>
		</div>
		<!-- #BeginLibraryItem "/library/new_goods_filter.lbi" --><!-- #EndLibraryItem -->
		<!-- #BeginLibraryItem "/library/new_search.lbi" --><!-- #EndLibraryItem -->
		<div class="div-messages"></div>
		<!-- #BeginLibraryItem "/library/new_page_footer.lbi" -->
		<!-- #EndLibraryItem -->
		<script type="text/javascript" src="__PUBLIC__/js/template.js"></script>
<script type="text/javascript">
$('#hide-div').delay(1500).hide(0);
	var sliders = function() {
		// 筛选价格区间 js
		$("#slider-range").slider({
			range: true,
			min: 0,
			max: 1000,
			step: 100,
			values: [0, 300],
			slide: function(event, ui) {
				$("#slider-range-amount").text(ui.values[0] + " ~ " + ui.values[1]);
				$('input[name=price_min]').val(ui.values[0]);
				$('input[name=price_max]').val(ui.values[1]);
			}
		});
		var price_min = $('input[name=price_min]').val();
		var price_max = $('input[name=price_max]').val();
		$("#slider-range").slider({values: [price_min, price_max]});
		$("#slider-range-amount").text(price_min + " ~ " + price_max);
	}();

	var url = '{:url('category/async_list', array('id'=>$this->_var['id'], 'type'=>$this->_var['type'], 'brand'=>$this->_var['brand_id'], 'price_min'=>$this->_var['price_min'], 'price_max'=>$this->_var['price_max'], 'filter_attr'=>$this->_var['filter_attr'], 'page'=>$this->_var['page'], 'sort'=>$this->_var['sort'], 'order'=>$this->_var['order'], 'keywords'=>$this->_var['keywords']))}';
	var total = 0;
	var page = localData.get('cat_{$id}_page');
	page = (page === null) ? 1:parseInt(page);
	// first request
	get_data(page);
	localData.set('cat_{$id}_page', page);
	if(page == 1){
		localData.set('cat_{$id}_page_min', 1);
		localData.set('cat_{$id}_page_max', 1);
	}
	if(page > 1){
		localData.set('cat_{$id}_page_min', page);
		localData.set('cat_{$id}_page_max', page);
	}
	var minPage = localData.get('cat_{$id}_page_max');
	var maxPage = localData.get('cat_{$id}_page_max');
	minPage = (minPage === null) ? 1:parseInt(minPage);
	maxPage = (maxPage === null) ? 1:parseInt(maxPage);

	$(window).scroll(function () {
		var scrollTop = $(this).scrollTop();
		var scrollHeight = $(document).height();
		var windowHeight = $(this).height();
		// 下拉
		if (scrollTop + windowHeight == scrollHeight) {
			if(page >= maxPage){
				$.ajax({
					type : "post",
					url : url,
					data : 'page=' + (page + 1),
					dataType: 'json',
					async : false,
					success : function(data){
						var html = template('j-product', data);
						$('#j-product-box').append(html);
						//rug
						if(!isEmpty(data.list)){
							page++;
							localData.set('cat_{$id}_page', page);
							if(page > maxPage){
								localData.set('cat_{$id}_page_max', page);
							}
						}
					}
				});
			}
		}
		// 上拉
		if(scrollTop == 0 && minPage > 1){
			$.ajax({
				type : "post",
				url : url,
				data : 'page=' + (page - 1),
				dataType: 'json',
				async : false,
				success : function(data){
					var html = template('j-product', data);
					$('#j-product-box').prepend(html);
					page--;
					localData.set('cat_{$id}_page', page);
					if(page < minPage){
						localData.set('cat_{$id}_page_min', page);
					}
				}
			});
		}
	});

	function get_data(page){
		$.ajax({
			type : "post",
			url : url,
			data : 'page=' + page,
			dataType: 'json',
			async : false,
			success : function(data){
				var html = template('j-product', data);
				$('#j-product-box').append(html);
			}
		});
	}

	/*
   * 检测对象是否是空对象(不包含任何可读属性)。
   * 方法既检测对象本身的属性，也检测从原型继承的属性(因此没有使hasOwnProperty)。
   */
  function isEmpty(obj) {
      for (var name in obj) {
          return false;
      }
      return true;
  }

</script>
	</body>
</html>
